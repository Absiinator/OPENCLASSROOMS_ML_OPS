# ============================================
# CI/CD - Tests, Build et Deploy
# ============================================
# Workflow unifi√© : Tests ‚Üí Build Docker ‚Üí Push GHCR
# Le d√©ploiement sur Render est MANUEL (tier gratuit)

name: CI/CD - Tests & Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  GHCR_OWNER: "absiinator"
  RENDER_DEPLOY_HOOK_API: ${{ vars.RENDER_DEPLOY_HOOK_API || secrets.RENDER_DEPLOY_HOOK_API }}
  RENDER_DEPLOY_HOOK_DASHBOARD: ${{ vars.RENDER_DEPLOY_HOOK_DASHBOARD || secrets.RENDER_DEPLOY_HOOK_DASHBOARD }}
  RENDER_DEPLOY_HOOK_MLFLOW: ${{ vars.RENDER_DEPLOY_HOOK_MLFLOW || secrets.RENDER_DEPLOY_HOOK_MLFLOW }}

jobs:
  # ============================================
  # Job 1: Linting et Syntaxe (BLOQUANT)
  # ============================================
  lint:
    name: üîç Lint & Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: üì¶ Installation des d√©pendances de linting
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort
      
      - name: üêç V√©rification syntaxe Python (BLOQUANT)
        run: |
          echo "üîç V√©rification syntaxe de tous les fichiers Python..."
          python -m py_compile src/*.py
          python -m py_compile api/*.py
          python -m py_compile streamlit_app/*.py
          python -m py_compile tests/*.py
          echo "‚úÖ Aucune erreur de syntaxe d√©tect√©e"
      
      - name: üé® V√©rification du formatage (black)
        run: black --check --diff src/ api/ tests/ || true
      
      - name: üìã V√©rification des imports (isort)
        run: isort --check-only --diff src/ api/ tests/ || true
      
      - name: üîç Analyse statique flake8 - Erreurs critiques (BLOQUANT)
        run: |
          # E9xx = Erreurs de syntaxe/runtime - BLOQUANT
          # F821 = undefined name - BLOQUANT
          # F822 = undefined name in __all__ - BLOQUANT
          flake8 src/ api/ streamlit_app/ tests/ --select=E9,F63,F7,F82 --show-source --statistics
      
      - name: üîç Analyse statique flake8 - Warnings (informatif)
        run: flake8 src/ api/ tests/ --max-line-length=120 --ignore=E501,W503,E203,E9,F63,F7,F82 || true

  # ============================================
  # Job 2: Tests unitaires (BLOQUANT)
  # ============================================
  test:
    name: üß™ Tests Unitaires
    runs-on: ubuntu-latest
    continue-on-error: false
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ÔøΩ Installation des d√©pendances
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install tomli
          pip install -r api/requirements.txt
          pip install pytest pytest-cov pytest-xdist httpx
          pip install -e .
      
      - name: üìã V√©rification de pyproject.toml
        run: |
          python -c "import sys; toml_lib = 'tomllib' if sys.version_info >= (3, 11) else 'tomli'; lib = __import__(toml_lib); lib.loads(open('pyproject.toml').read()); print('‚úÖ pyproject.toml est valide')"
      
      - name: üß™ Ex√©cution des tests (hors test_api.py)
        run: |
          pytest tests/ -v --tb=short \
            --cov=src --cov=api \
            --cov-report=term-missing \
            --ignore=tests/test_api.py
      
      - name: üß™ Tests API
        run: pytest tests/test_api.py -v --tb=short

  # ============================================
  # Job 3: Build et Push des images Docker
  # ============================================
  build-and-push:
    name: üê≥ Build & Push Docker
    runs-on: ubuntu-latest
    needs: [lint, test]  # DOIT passer lint ET test avant build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
      
      - name: üê≥ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: üîê Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # ===== BUILD API =====
      - name: üìã M√©tadonn√©es API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.GHCR_OWNER }}/openclassrooms-ml-ops-api
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: üî® Build et Push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./api/Dockerfile
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api
          platforms: linux/amd64
      
      # ===== BUILD DASHBOARD =====
      - name: üìã M√©tadonn√©es Dashboard
        id: meta-dashboard
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.GHCR_OWNER }}/openclassrooms-ml-ops-dashboard
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: üî® Build et Push Dashboard
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./streamlit_app/Dockerfile
          push: true
          tags: ${{ steps.meta-dashboard.outputs.tags }}
          labels: ${{ steps.meta-dashboard.outputs.labels }}
          cache-from: type=gha,scope=dashboard
          cache-to: type=gha,mode=max,scope=dashboard
          platforms: linux/amd64
      
      # ===== BUILD MLFLOW =====
      - name: üìã M√©tadonn√©es MLflow
        id: meta-mlflow
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.GHCR_OWNER }}/openclassrooms-ml-ops-mlflow
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: üî® Build et Push MLflow
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./mlflow/Dockerfile
          push: true
          tags: ${{ steps.meta-mlflow.outputs.tags }}
          labels: ${{ steps.meta-mlflow.outputs.labels }}
          cache-from: type=gha,scope=mlflow
          cache-to: type=gha,mode=max,scope=mlflow
          platforms: linux/amd64

      # ===== Trigger Render Deploy Hooks (optionnel) =====
      - name: üöÄ Trigger Render Deploy Hooks
        if: env.RENDER_DEPLOY_HOOK_API != '' || env.RENDER_DEPLOY_HOOK_DASHBOARD != '' || env.RENDER_DEPLOY_HOOK_MLFLOW != ''
        run: |
          set -e
          trigger() {
            name="$1"
            url="$2"
            if [ -n "$url" ]; then
              echo "‚ñ∂Ô∏è D√©ploiement Render: $name"
              curl -sS -X POST "$url" -o /dev/null
              echo "‚úÖ Hook $name d√©clench√©"
            else
              echo "‚è≠Ô∏è Hook $name non configur√©"
            fi
          }
          trigger "API" "$RENDER_DEPLOY_HOOK_API"
          trigger "Dashboard" "$RENDER_DEPLOY_HOOK_DASHBOARD"
          trigger "MLflow" "$RENDER_DEPLOY_HOOK_MLFLOW"

  # ============================================
  # Job 4: R√©sum√© du d√©ploiement
  # ============================================
  summary:
    name: üì¨ R√©sum√©
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always() && (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped')
    
    steps:
      - name: üì¨ R√©sum√© du build
        run: |
          echo "=========================================="
          echo "       WORKFLOW TERMIN√â ‚úÖ"
          echo "=========================================="
          echo ""
          if [ "${{ needs.build-and-push.result }}" = "success" ]; then
            echo "‚úÖ Images Docker construites et publi√©es sur GHCR:"
            echo "- ghcr.io/${{ env.GHCR_OWNER }}/openclassrooms-ml-ops-api:latest"
            echo "- ghcr.io/${{ env.GHCR_OWNER }}/openclassrooms-ml-ops-dashboard:latest"
            echo "- ghcr.io/${{ env.GHCR_OWNER }}/openclassrooms-ml-ops-mlflow:latest"
            echo ""
            echo "üöÄ Pour d√©ployer sur Render:"
            echo "   1. Allez sur dashboard.render.com"
            echo "   2. Ouvrez chaque service"
            echo "   3. Cliquez 'Manual Deploy' ‚Üí 'Deploy latest commit'"
          else
            echo "‚ö†Ô∏è Build Docker ignor√© (non d√©clench√©)"
            echo "Les images Docker ne sont construites QUE pour:"
            echo "   - Les PUSHES (pas les PR)"
            echo "   - Sur la branche 'main' (pas 'develop')"
            echo ""
            echo "üí° Astuce: Fusionnez sur 'main' pour d√©clencher le build Docker"
          fi
