# ============================================
# CD - DÃ©ploiement Continu
# ============================================
# Ce workflow dÃ©ploie l'API et le Dashboard sur Render.
# IL S'EXÃ‰CUTE UNIQUEMENT APRÃˆS LA RÃ‰USSITE DE LA CI.

name: CD - Deploy

on:
  # DÃ©clenchÃ© uniquement aprÃ¨s succÃ¨s du workflow CI
  workflow_run:
    workflows: ["CI - Tests & Linting"]
    types: [completed]
    branches: [main]
  
  # DÃ©ploiement manuel possible
  workflow_dispatch:
    inputs:
      deploy_api:
        description: 'DÃ©ployer API'
        required: true
        default: true
        type: boolean
      deploy_dashboard:
        description: 'DÃ©ployer Dashboard'
        required: true
        default: true
        type: boolean

env:
  PYTHON_VERSION: "3.10"

jobs:
  # ============================================
  # Job 0: VÃ©rification CI Success
  # ============================================
  check-ci:
    name: ğŸ” VÃ©rification CI
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    outputs:
      should_deploy: ${{ steps.check.outputs.deploy }}
    
    steps:
      - name: âœ… CI rÃ©ussie - DÃ©ploiement autorisÃ©
        id: check
        run: |
          echo "deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… La CI a rÃ©ussi, dÃ©ploiement autorisÃ©"

  # ============================================
  # Job 1: Build et Push Docker API
  # ============================================
  build-api:
    name: ğŸ³ Build API
    runs-on: ubuntu-latest
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“‹ Extraction des mÃ©tadonnÃ©es
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/openclassrooms-ml-ops-api
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: ğŸ”¨ Build et Push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================
  # Job 2: Build et Push Docker Dashboard
  # ============================================
  build-dashboard:
    name: ğŸ³ Build Dashboard
    runs-on: ubuntu-latest
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“‹ Extraction des mÃ©tadonnÃ©es
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/openclassrooms-ml-ops-dashboard
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: ğŸ”¨ Build et Push Dashboard
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./streamlit_app/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================
  # Job 3: Build et Push Docker MLflow
  # ============================================
  build-mlflow:
    name: ğŸ³ Build MLflow UI
    runs-on: ubuntu-latest
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“‹ Extraction des mÃ©tadonnÃ©es
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/openclassrooms-ml-ops-mlflow
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: ğŸ”¨ Build et Push MLflow
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./mlflow/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================
  # Job 4: DÃ©ploiement API sur Render
  # ============================================
  deploy-api:
    name: ğŸš€ Deploy API (Render)
    runs-on: ubuntu-latest
    needs: build-api
    environment:
      name: production-api
      url: ${{ steps.deploy.outputs.url }}
    
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ï¿½ Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: ï¿½ğŸš€ DÃ©ploiement API sur Render
        id: deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_API: ${{ secrets.RENDER_SERVICE_API }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_API" ]; then
            # DÃ©clencher le dÃ©ploiement
            curl -s -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_API}/deploys"
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache": false}' || true
            
            # Attendre et rÃ©cupÃ©rer les infos du service
            sleep 5
            SERVICE_JSON=$(curl -s -X GET "https://api.render.com/v1/services/${RENDER_SERVICE_API}" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json")
            
            # Extraire l'URL du service
            SERVICE_URL=$(echo "$SERVICE_JSON" | jq -r '.service.serviceDetails.url // .service.url // empty' | sed 's|https://||')
            
            # Fallback si extraction Ã©choue
            if [ -z "$SERVICE_URL" ] || [ "$SERVICE_URL" = "null" ]; then
              SERVICE_URL="home-credit-api.onrender.com"
            fi
            
            echo "url=https://${SERVICE_URL}" >> $GITHUB_OUTPUT
            echo "âœ… DÃ©ploiement API dÃ©clenchÃ©: https://${SERVICE_URL}"
          else
            echo "âš ï¸ Secrets Render non configurÃ©s - DÃ©ploiement simulÃ©"
            echo "url=https://home-credit-api.onrender.com" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Job 4: DÃ©ploiement Dashboard sur Render
  # ============================================
  deploy-dashboard:
    name: ğŸš€ Deploy Dashboard (Render)
    runs-on: ubuntu-latest
    needs: [build-dashboard, deploy-api, deploy-mlflow]
    environment:
      name: production-dashboard
      url: ${{ steps.deploy.outputs.url }}
    
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ï¿½ Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ğŸš€ DÃ©ploiement Dashboard sur Render
        id: deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_DASHBOARD: ${{ secrets.RENDER_SERVICE_DASHBOARD }}
          API_URL: ${{ needs.deploy-api.outputs.url }}
          MLFLOW_URL: ${{ needs.deploy-mlflow.outputs.url }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_DASHBOARD" ]; then
            # DÃ©clencher le dÃ©ploiement avec l'URL de l'API en variable d'environnement
            curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_DASHBOARD}/deploys" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache": false}'
            
            # Attendre et rÃ©cupÃ©rer les infos du service
            sleep 5
            SERVICE_JSON=$(curl -s -X GET "https://api.render.com/v1/services/${RENDER_SERVICE_DASHBOARD}" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json")
            
            # Extraire l'URL du service
            SERVICE_URL=$(echo "$SERVICE_JSON" | jq -r '.service.serviceDetails.url // .service.url // empty' | sed 's|https://||')
            
            # Fallback si extraction Ã©choue
            if [ -z "$SERVICE_URL" ] || [ "$SERVICE_URL" = "null" ]; then
              SERVICE_URL="home-credit-dashboard.onrender.com"
            fi
            
            echo "url=https://${SERVICE_URL}" >> $GITHUB_OUTPUT
            echo "âœ… DÃ©ploiement Dashboard dÃ©clenchÃ©: https://${SERVICE_URL}"
            echo "ğŸ”— API URL passÃ©e au Dashboard: ${API_URL}"
            echo "ğŸ”¬ MLflow URL passÃ©e au Dashboard: ${MLFLOW_URL}"
          else
            echo "âš ï¸ Secrets Render non configurÃ©s - DÃ©ploiement simulÃ©"
            echo "url=https://home-credit-dashboard.onrender.com" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Job 6: DÃ©ploiement MLflow sur Render
  # ============================================
  deploy-mlflow:
    name: ğŸš€ Deploy MLflow UI (Render)
    runs-on: ubuntu-latest
    needs: build-mlflow
    environment:
      name: production-mlflow
      url: ${{ steps.deploy.outputs.url }}
    
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ğŸ“¦ Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ğŸš€ DÃ©ploiement MLflow sur Render
        id: deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_MLFLOW: ${{ secrets.RENDER_SERVICE_MLFLOW }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_MLFLOW" ]; then
            # DÃ©clencher le dÃ©ploiement
            curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_MLFLOW}/deploys" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache": false}'
            
            # Attendre et rÃ©cupÃ©rer les infos du service
            sleep 5
            SERVICE_JSON=$(curl -s -X GET "https://api.render.com/v1/services/${RENDER_SERVICE_MLFLOW}" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json")
            
            # Extraire l'URL du service
            SERVICE_URL=$(echo "$SERVICE_JSON" | jq -r '.service.serviceDetails.url // .service.url // empty' | sed 's|https://||')
            
            # Fallback si extraction Ã©choue
            if [ -z "$SERVICE_URL" ] || [ "$SERVICE_URL" = "null" ]; then
              SERVICE_URL="home-credit-mlflow.onrender.com"
            fi
            
            echo "url=https://${SERVICE_URL}" >> $GITHUB_OUTPUT
            echo "âœ… DÃ©ploiement MLflow dÃ©clenchÃ©: https://${SERVICE_URL}"
          else
            echo "âš ï¸ Secrets Render non configurÃ©s - DÃ©ploiement simulÃ©"
            echo "url=https://home-credit-mlflow.onrender.com" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Job 7: Tests post-dÃ©ploiement
  # ============================================
  smoke-tests:
    name: ğŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-dashboard, deploy-mlflow]
    
    steps:
      - name: â³ Attente du dÃ©ploiement
        run: sleep 90
      
      - name: ğŸ§ª Test API Health
        run: |
          API_URL="${{ needs.deploy-api.outputs.url }}"
          if [ -z "$API_URL" ]; then
            API_URL="https://home-credit-api.onrender.com"
          fi
          echo "ğŸ” Test de l'endpoint /health..."
          curl -f "${API_URL}/health" || echo "âš ï¸ API pas encore prÃªte (cold start Render)"
        continue-on-error: true
      
      - name: ğŸ§ª Test Dashboard Health
        run: |
          DASH_URL="${{ needs.deploy-dashboard.outputs.url }}"
          if [ -z "$DASH_URL" ]; then
            DASH_URL="https://home-credit-dashboard.onrender.com"
          fi
          echo "ğŸ” Test du dashboard..."
          curl -f "${DASH_URL}/_stcore/health" || echo "âš ï¸ Dashboard pas encore prÃªt"
        continue-on-error: true
      
      - name: ğŸ§ª Test MLflow UI Health
        run: |
          MLFLOW_URL="${{ needs.deploy-mlflow.outputs.url }}"
          if [ -z "$MLFLOW_URL" ]; then
            MLFLOW_URL="https://home-credit-mlflow.onrender.com"
          fi
          echo "ğŸ” Test de MLflow UI..."
          curl -f "${MLFLOW_URL}" || echo "âš ï¸ MLflow UI pas encore prÃªt"
        continue-on-error: true

  # ============================================
  # Job 8: Notification finale
  # ============================================
  notify:
    name: ğŸ“¬ Notification
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-dashboard, deploy-mlflow, smoke-tests]
    if: always()
    
    steps:
      - name: ğŸ“¬ RÃ©sumÃ© du dÃ©ploiement
        run: |
          echo "=========================================="
          echo "       RÃ‰SUMÃ‰ DU DÃ‰PLOIEMENT"
          echo "=========================================="
          echo ""
          echo "ğŸŒ API:       ${{ needs.deploy-api.outputs.url }}"
          echo "ğŸ“Š Dashboard: ${{ needs.deploy-dashboard.outputs.url }}"
          echo "ğŸ”¬ MLflow:    ${{ needs.deploy-mlflow.outputs.url }}"
          echo ""
          if [[ "${{ needs.deploy-api.result }}" == "success" ]]; then
            echo "âœ… API dÃ©ployÃ©e avec succÃ¨s"
          else
            echo "âŒ Ã‰chec du dÃ©ploiement API"
          fi
          if [[ "${{ needs.deploy-dashboard.result }}" == "success" ]]; then
            echo "âœ… Dashboard dÃ©ployÃ© avec succÃ¨s"
          else
            echo "âŒ Ã‰chec du dÃ©ploiement Dashboard"
          fi
          if [[ "${{ needs.deploy-mlflow.result }}" == "success" ]]; then
            echo "âœ… MLflow UI dÃ©ployÃ© avec succÃ¨s"
          else
            echo "âŒ Ã‰chec du dÃ©ploiement MLflow"
          fi
