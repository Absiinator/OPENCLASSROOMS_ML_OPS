# ============================================
# CD - Build et Push Docker Images
# ============================================
# Ce workflow build les images Docker et les pousse vers GHCR.
# Le dÃ©ploiement sur Render est MANUEL (tier gratuit).

name: CD - Deploy

on:
  # DÃ©clenchÃ© uniquement aprÃ¨s succÃ¨s du workflow CI
  workflow_run:
    workflows: ["CI - Tests & Linting"]
    types: [completed]
    branches: [main]
  
  # Build manuel possible
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"

jobs:
  # ============================================
  # Job 0: VÃ©rification CI Success
  # ============================================
  check-ci:
    name: ğŸ” VÃ©rification CI
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    outputs:
      should_deploy: ${{ steps.check.outputs.deploy }}
    
    steps:
      - name: âœ… CI rÃ©ussie - Build autorisÃ©
        id: check
        run: |
          echo "deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… La CI a rÃ©ussi, build des images Docker autorisÃ©"

  # ============================================
  # Job 1: Build et Push Docker API
  # ============================================
  build-api:
    name: ğŸ³ Build API
    runs-on: ubuntu-latest
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“‹ Extraction des mÃ©tadonnÃ©es
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/openclassrooms-ml-ops-api
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: ğŸ”¨ Build et Push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================
  # Job 2: Build et Push Docker Dashboard
  # ============================================
  build-dashboard:
    name: ğŸ³ Build Dashboard
    runs-on: ubuntu-latest
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“‹ Extraction des mÃ©tadonnÃ©es
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/openclassrooms-ml-ops-dashboard
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: ğŸ”¨ Build et Push Dashboard
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./streamlit_app/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================
  # Job 3: Build et Push Docker MLflow
  # ============================================
  build-mlflow:
    name: ğŸ³ Build MLflow UI
    runs-on: ubuntu-latest
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“‹ Extraction des mÃ©tadonnÃ©es
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/openclassrooms-ml-ops-mlflow
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: ğŸ”¨ Build et Push MLflow
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./mlflow/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================
  # Job 4: Notification finale
  # ============================================
  notify:
    name: ğŸ“¬ Notification
    runs-on: ubuntu-latest
    needs: [build-api, build-dashboard, build-mlflow]
    if: always()
    
    steps:
      - name: ğŸ“¬ RÃ©sumÃ© du build
        run: |
          echo "=========================================="
          echo "       RÃ‰SUMÃ‰ DU BUILD DOCKER"
          echo "=========================================="
          echo ""
          echo "ğŸ“¦ Images disponibles sur GHCR:"
          echo "   - ghcr.io/${{ github.repository_owner }}/openclassrooms-ml-ops-api:latest"
          echo "   - ghcr.io/${{ github.repository_owner }}/openclassrooms-ml-ops-dashboard:latest"
          echo "   - ghcr.io/${{ github.repository_owner }}/openclassrooms-ml-ops-mlflow:latest"
          echo ""
          if [[ "${{ needs.build-api.result }}" == "success" ]]; then
            echo "âœ… API image built successfully"
          else
            echo "âŒ Ã‰chec du build API"
          fi
          if [[ "${{ needs.build-dashboard.result }}" == "success" ]]; then
            echo "âœ… Dashboard image built successfully"
          else
            echo "âŒ Ã‰chec du build Dashboard"
          fi
          if [[ "${{ needs.build-mlflow.result }}" == "success" ]]; then
            echo "âœ… MLflow image built successfully"
          else
            echo "âŒ Ã‰chec du build MLflow"
          fi
          echo ""
          echo "ğŸš€ DÃ©ployez manuellement sur Render avec Manual Deploy"
