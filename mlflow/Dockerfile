# =============================================================================
# Dockerfile - MLflow UI Server (Ultra-Light pour Render Free Tier)
# =============================================================================
# Image minimaliste pour le tracking MLflow sur Render (512MB RAM)
# Utilise mlflow ui (Flask) au lieu de mlflow server (gunicorn) = moins de RAM
#
# VARIABLES D'ENVIRONNEMENT:
# - PORT: dÃ©fini par Render automatiquement (dÃ©faut: 5000)
# =============================================================================

FROM python:3.10-slim

# MÃ©tadonnÃ©es
LABEL maintainer="Home Credit Scoring Team"
LABEL version="1.0.0"
LABEL description="MLflow UI Server - Ultra Light"

# Variables d'environnement (PORT sera Ã©crasÃ© par Render)
ARG PORT=5000
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PORT=${PORT} \
    MLFLOW_TRACKING_URI=/app/mlruns

WORKDIR /app

# Installer MLflow version lÃ©gÃ¨re (sans extras lourds)
RUN pip install --no-cache-dir "mlflow==2.9.2" \
    && pip cache purge \
    && rm -rf /root/.cache

# CrÃ©er le rÃ©pertoire mlruns
RUN mkdir -p /app/mlruns

# Copier les expÃ©riences (notebooks/mlruns avec chemins normalisÃ©s)
COPY notebooks/mlruns/. /app/mlruns/

# VÃ©rifier la structure - pas besoin de sed complexe car les chemins sont relatifs!
RUN echo "ðŸ“ Structure MLflow (chemins relatifs = reproductibles):" && \
    ls -la /app/mlruns/ && \
    echo "âœ… MLflow prÃªt pour dÃ©ploiement"

# Exposer le port
EXPOSE ${PORT}

# Health check (MLflow UI rÃ©pond sur /)
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:${PORT}/ || exit 1

# Commande de dÃ©marrage avec logs dÃ©taillÃ©s
CMD ["sh", "-c", "echo '[MLflow] === DÃ‰MARRAGE ===' && echo '[MLflow] PORT=${PORT}' && echo '[MLflow] Contenu mlruns:' && ls -la /app/mlruns/ && echo '[MLflow] ExpÃ©riences:' && ls /app/mlruns/*/meta.yaml 2>/dev/null | head -5 && echo '[MLflow] DÃ©marrage UI...' && mlflow ui --host 0.0.0.0 --port ${PORT} --backend-store-uri /app/mlruns"]
