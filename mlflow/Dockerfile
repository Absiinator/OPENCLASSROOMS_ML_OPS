# =============================================================================
# Dockerfile - MLflow UI Server (Ultra-Light pour Render Free Tier)
# =============================================================================
# Image minimaliste pour le tracking MLflow sur Render (512MB RAM)
# IMPORTANT: Utilise Flask directement avec --workers 1 pour √©viter OOM
#
# VARIABLES D'ENVIRONNEMENT:
# - PORT: d√©fini par Render automatiquement (d√©faut: 5000)
# =============================================================================

FROM python:3.10-slim

# M√©tadonn√©es
LABEL maintainer="Home Credit Scoring Team"
LABEL version="1.0.1"
LABEL description="MLflow UI Server - Ultra Light (Single Worker)"

# Variables d'environnement (PORT sera √©cras√© par Render)
ARG PORT=5000
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PORT=${PORT} \
    MLFLOW_TRACKING_URI=/app/mlruns \
    # IMPORTANT: Limiter gunicorn √† 1 worker pour free tier
    GUNICORN_CMD_ARGS="--workers=1 --threads=2 --timeout=120"

WORKDIR /app

# Installer MLflow version l√©g√®re (sans extras lourds)
RUN pip install --no-cache-dir "mlflow==2.9.2" \
    && pip cache purge \
    && rm -rf /root/.cache

# Cr√©er le r√©pertoire mlruns
RUN mkdir -p /app/mlruns

# Copier les exp√©riences (notebooks/mlruns)
COPY notebooks/mlruns/. /app/mlruns/

# Nettoyer et corriger les chemins absolus ‚Üí relatifs pour Docker
# Les meta.yaml peuvent contenir des chemins locaux qu'il faut corriger
RUN echo "üîß Correction des chemins MLflow..." && \
    rm -rf /app/mlruns/.trash 2>/dev/null || true && \
    # Corriger artifact_location (exp√©riences) - remplacer tout chemin absolu par le r√©pertoire courant
    find /app/mlruns -name "meta.yaml" -exec sed -i 's|artifact_location:.*mlruns/[0-9]*|artifact_location: .|g' {} \; 2>/dev/null || true && \
    # Corriger artifact_uri (runs) - remplacer par chemin relatif vers artifacts
    find /app/mlruns -path '*/*[0-9a-f]*/meta.yaml' -exec sed -i 's|artifact_uri:.*artifacts$|artifact_uri: ./artifacts|g' {} \; 2>/dev/null || true && \
    find /app/mlruns -path '*/*[0-9a-f]*/meta.yaml' -exec sed -i 's|artifact_uri:.*/artifacts$|artifact_uri: ./artifacts|g' {} \; 2>/dev/null || true && \
    # V√©rification
    echo "=== Structure MLruns ===" && \
    ls -la /app/mlruns/ && \
    echo "=== Exemples de meta.yaml ===" && \
    head -3 /app/mlruns/*/meta.yaml 2>/dev/null || echo "Pas de meta.yaml trouv√©" && \
    echo "‚úÖ MLflow pr√™t"

# Exposer le port
EXPOSE ${PORT}

# PAS de healthcheck avec curl (n√©cessite installation suppl√©mentaire)
# Render g√®re son propre healthcheck

# Commande de d√©marrage - Flask simple avec 1 seul worker pour √©viter OOM
# IMPORTANT: --workers 1 est CRITIQUE pour le free tier 512MB
CMD ["sh", "-c", "echo '[MLflow] D√©marrage sur port ${PORT} (1 worker pour free tier)' && mlflow server --host 0.0.0.0 --port ${PORT} --backend-store-uri /app/mlruns --serve-artifacts --workers 1"]
