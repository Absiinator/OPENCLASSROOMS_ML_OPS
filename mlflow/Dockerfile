# =============================================================================
# Dockerfile - MLflow UI Server
# =============================================================================
# Image optimis√©e pour le tracking MLflow sur Render
# Configuration ultra-l√©g√®re pour tier gratuit (512MB RAM)

FROM python:3.10-slim

# M√©tadonn√©es
LABEL maintainer="Home Credit Scoring Team"
LABEL version="1.0.0"
LABEL description="MLflow UI Server Home Credit Scoring"

# Variables d'environnement (aucune variable sp√©cifique requise sur Render pour MLflow)
# PORT sera d√©fini automatiquement par Render
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PORT=5000

WORKDIR /app

# Installer MLflow sans d√©pendances lourdes (version minimale pour UI)
RUN pip install --no-cache-dir mlflow==2.9.2

# Cr√©er le r√©pertoire mlruns
RUN mkdir -p /app/mlruns

# IMPORTANT: On copie SEULEMENT notebooks/mlruns qui contient les vraies exp√©riences
# Le dossier mlruns/ √† la racine contient un doublon qu'on ignore
COPY notebooks/mlruns/. /app/mlruns/

# Nettoyer les fichiers .trash et corriger les chemins absolus pour Docker
RUN echo "üîß Nettoyage et configuration MLflow..." && \
    rm -rf /app/mlruns/.trash 2>/dev/null || true && \
    # Corriger artifact_location dans meta.yaml des exp√©riences
    find /app/mlruns -maxdepth 2 -name "meta.yaml" -type f -exec sed -i 's|artifact_location:.*|artifact_location: /app/mlruns|g' {} \; 2>/dev/null || true && \
    # Corriger artifact_uri dans meta.yaml des runs (chemins locaux -> Docker)
    find /app/mlruns -name "meta.yaml" -type f -exec sed -i 's|artifact_uri:.*home-credit-scoring/notebooks/mlruns/|artifact_uri: /app/mlruns/|g' {} \; 2>/dev/null || true && \
    find /app/mlruns -name "meta.yaml" -type f -exec sed -i 's|artifact_uri:.*Lepage_Jeffrey.*mlruns/|artifact_uri: /app/mlruns/|g' {} \; 2>/dev/null || true && \
    # Afficher le contenu pour debug
    echo "=== Experiments trouv√©s ===" && \
    find /app/mlruns -maxdepth 2 -name "meta.yaml" -exec dirname {} \; 2>/dev/null && \
    echo "=== Runs trouv√©s ===" && \
    find /app/mlruns -maxdepth 3 -type d -name "[0-9a-f]*" 2>/dev/null | head -10 && \
    echo "‚úÖ MLflow configur√©"

# Exposer le port
EXPOSE ${PORT}

# Commande de d√©marrage avec mlflow ui (plus l√©ger que mlflow server)
# mlflow ui utilise Flask int√©gr√© au lieu de gunicorn - parfait pour tier gratuit
# Options: --host pour √©couter sur toutes interfaces, --port dynamique Render
CMD ["sh", "-c", "mlflow ui --host 0.0.0.0 --port ${PORT} --backend-store-uri /app/mlruns"]
