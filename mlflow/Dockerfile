# =============================================================================
# Dockerfile - MLflow UI Server
# =============================================================================
# Image optimis√©e pour le tracking MLflow sur Render
# Configuration l√©g√®re pour tier gratuit (512MB RAM)

FROM python:3.10-slim

# M√©tadonn√©es
LABEL maintainer="Home Credit Scoring Team"
LABEL version="1.0.0"
LABEL description="MLflow UI Server Home Credit Scoring"

# Variables d'environnement
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    MLFLOW_TRACKING_URI=/app/mlruns \
    PORT=5000

WORKDIR /app

# Installer MLflow (version l√©g√®re pour tier gratuit)
RUN pip install --no-cache-dir mlflow==2.9.2

# Cr√©er le r√©pertoire pour les artefacts MLflow
RUN mkdir -p /app/mlruns /app/notebooks_mlruns /app/mlruns_root

# Copier les runs MLflow depuis les 2 sources
# 1. mlruns/ √† la racine du projet (peut contenir des runs)
COPY mlruns/. /app/mlruns_root/

# 2. notebooks/mlruns/ qui contient les vrais runs d'exp√©riences
COPY notebooks/mlruns/. /app/notebooks_mlruns/

# Fusionner les deux sources dans /app/mlruns (destination finale)
RUN echo "üì¶ Copie des MLflow runs..." && \
    echo "=== Contenu mlruns_root ===" && \
    ls -la /app/mlruns_root/ && \
    echo "=== Contenu notebooks_mlruns ===" && \
    ls -la /app/notebooks_mlruns/ && \
    echo "=== Fusion dans mlruns ===" && \
    cp -rv /app/mlruns_root/* /app/mlruns/ 2>/dev/null || true && \
    cp -rv /app/notebooks_mlruns/* /app/mlruns/ 2>/dev/null || true && \
    rm -rf /app/notebooks_mlruns /app/mlruns_root && \
    echo "‚úÖ Fusion termin√©e" && \
    echo "=== Contenu final mlruns ===" && \
    ls -laR /app/mlruns/ | head -50 && \
    echo "=== Recherche meta.yaml ===" && \
    find /app/mlruns -name "meta.yaml" -type f 2>/dev/null | head -20 || echo "‚ö†Ô∏è Aucun meta.yaml trouv√©"

# Exposer le port
EXPOSE ${PORT}

# Commande de d√©marrage du serveur MLflow
# Configuration optimis√©e pour tier gratuit Render (512MB RAM):
# - 1 worker au lieu de 4 par d√©faut
# - Timeout √©lev√© pour √©viter les WORKER TIMEOUT
CMD mlflow server \
    --host 0.0.0.0 \
    --port ${PORT} \
    --backend-store-uri /app/mlruns \
    --default-artifact-root /app/mlruns \
    --workers 1 \
    --gunicorn-opts "--timeout 120 --keep-alive 5 --log-level warning"
