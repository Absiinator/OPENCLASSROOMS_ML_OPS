# ============================================
# CD - DÃ©ploiement Continu
# ============================================
# Ce workflow dÃ©ploie l'API sur Render ou Railway
# lors d'un push sur la branche main.

name: CD - Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de dÃ©ploiement'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: "3.10"
  DOCKER_IMAGE: home-credit-scoring

jobs:
  # ============================================
  # Job 1: Validation prÃ©-dÃ©ploiement
  # ============================================
  validate:
    name: âœ… Validation
    runs-on: ubuntu-latest
    
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ” VÃ©rification des fichiers modifiÃ©s
        id: check
        run: |
          # DÃ©ployer si des fichiers critiques ont changÃ©
          echo "should_deploy=true" >> $GITHUB_OUTPUT

  # ============================================
  # Job 2: Build et Push Docker
  # ============================================
  build-and-push:
    name: ğŸ³ Build & Push
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true
      
      - name: ğŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“‹ Extraction des mÃ©tadonnÃ©es
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: ğŸ”¨ Build et Push
        uses: docker/build-push-action@v5
        with:
          context: ./api
          file: ./api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================
  # Job 3: DÃ©ploiement Render
  # ============================================
  deploy-render:
    name: ğŸš€ Deploy Render
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸš€ DÃ©ploiement sur Render
        id: deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
            curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache": false}'
            echo "url=https://home-credit-scoring.onrender.com" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Secrets Render non configurÃ©s - DÃ©ploiement simulÃ©"
            echo "url=https://home-credit-scoring.onrender.com" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Job 4: DÃ©ploiement Railway (Alternative)
  # ============================================
  deploy-railway:
    name: ğŸš‚ Deploy Railway
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && false  # DÃ©sactivÃ© par dÃ©faut
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸš‚ Installation Railway CLI
        run: npm install -g @railway/cli
      
      - name: ğŸš€ DÃ©ploiement sur Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -n "$RAILWAY_TOKEN" ]; then
            railway up --detach
          else
            echo "âš ï¸ Token Railway non configurÃ©"
          fi

  # ============================================
  # Job 5: Tests post-dÃ©ploiement
  # ============================================
  smoke-tests:
    name: ğŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-render
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: â³ Attente du dÃ©ploiement
        run: sleep 60
      
      - name: ğŸ§ª Tests de fumÃ©e
        run: |
          API_URL="${{ needs.deploy-render.outputs.url }}"
          if [ -z "$API_URL" ]; then
            API_URL="https://home-credit-scoring.onrender.com"
          fi
          
          echo "ğŸ” Test de l'endpoint /health..."
          curl -f "${API_URL}/health" || echo "âš ï¸ Health check Ã©chouÃ© (normal si premier dÃ©ploiement)"
          
          echo "ğŸ” Test de l'endpoint /..."
          curl -f "${API_URL}/" || echo "âš ï¸ Root endpoint Ã©chouÃ©"
          
          echo "ğŸ” Test de l'endpoint /docs..."
          curl -f "${API_URL}/docs" || echo "âš ï¸ Docs endpoint Ã©chouÃ©"
        continue-on-error: true

  # ============================================
  # Job 6: Notification
  # ============================================
  notify:
    name: ğŸ“¬ Notification
    runs-on: ubuntu-latest
    needs: [deploy-render, smoke-tests]
    if: always()
    
    steps:
      - name: ğŸ“¬ Notification de succÃ¨s
        if: needs.deploy-render.result == 'success'
        run: |
          echo "âœ… DÃ©ploiement rÃ©ussi!"
          echo "ğŸ”— URL: ${{ needs.deploy-render.outputs.url }}"
      
      - name: ğŸ“¬ Notification d'Ã©chec
        if: needs.deploy-render.result == 'failure'
        run: |
          echo "âŒ Ã‰chec du dÃ©ploiement"
          exit 1
