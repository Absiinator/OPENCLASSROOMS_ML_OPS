# ============================================
# CD - DÃ©ploiement Continu
# ============================================
# Ce workflow dÃ©ploie l'API et le Dashboard sur Render.
# IL S'EXÃ‰CUTE UNIQUEMENT APRÃˆS LA RÃ‰USSITE DE LA CI.

name: CD - Deploy

on:
  # DÃ©clenchÃ© uniquement aprÃ¨s succÃ¨s du workflow CI
  workflow_run:
    workflows: ["CI - Tests & Linting"]
    types: [completed]
    branches: [main]
  
  # DÃ©ploiement manuel possible
  workflow_dispatch:
    inputs:
      deploy_api:
        description: 'DÃ©ployer API'
        required: true
        default: true
        type: boolean
      deploy_dashboard:
        description: 'DÃ©ployer Dashboard'
        required: true
        default: true
        type: boolean

env:
  PYTHON_VERSION: "3.10"

jobs:
  # ============================================
  # Job 0: VÃ©rification CI Success
  # ============================================
  check-ci:
    name: ğŸ” VÃ©rification CI
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    outputs:
      should_deploy: ${{ steps.check.outputs.deploy }}
    
    steps:
      - name: âœ… CI rÃ©ussie - DÃ©ploiement autorisÃ©
        id: check
        run: |
          echo "deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… La CI a rÃ©ussi, dÃ©ploiement autorisÃ©"

  # ============================================
  # Job 1: Build et Push Docker API
  # ============================================
  build-api:
    name: ğŸ³ Build API
    runs-on: ubuntu-latest
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“‹ Extraction des mÃ©tadonnÃ©es
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}-api
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: ğŸ”¨ Build et Push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================
  # Job 2: Build et Push Docker Dashboard
  # ============================================
  build-dashboard:
    name: ğŸ³ Build Dashboard
    runs-on: ubuntu-latest
    needs: check-ci
    if: needs.check-ci.outputs.should_deploy == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Login GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“‹ Extraction des mÃ©tadonnÃ©es
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}-dashboard
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest
      
      - name: ğŸ”¨ Build et Push Dashboard
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./streamlit_app/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================
  # Job 3: DÃ©ploiement API sur Render
  # ============================================
  deploy-api:
    name: ğŸš€ Deploy API (Render)
    runs-on: ubuntu-latest
    needs: build-api
    environment:
      name: production-api
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ğŸš€ DÃ©ploiement API sur Render
        id: deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_API_SERVICE_ID: ${{ secrets.RENDER_API_SERVICE_ID }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_API_SERVICE_ID" ]; then
            curl -X POST "https://api.render.com/v1/services/${RENDER_API_SERVICE_ID}/deploys" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache": false}'
            echo "url=https://home-credit-api.onrender.com" >> $GITHUB_OUTPUT
            echo "âœ… DÃ©ploiement API dÃ©clenchÃ©"
          else
            echo "âš ï¸ Secrets Render non configurÃ©s - DÃ©ploiement simulÃ©"
            echo "url=https://home-credit-api.onrender.com" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Job 4: DÃ©ploiement Dashboard sur Render
  # ============================================
  deploy-dashboard:
    name: ğŸš€ Deploy Dashboard (Render)
    runs-on: ubuntu-latest
    needs: [build-dashboard, deploy-api]
    environment:
      name: production-dashboard
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ğŸš€ DÃ©ploiement Dashboard sur Render
        id: deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_DASHBOARD_SERVICE_ID: ${{ secrets.RENDER_DASHBOARD_SERVICE_ID }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_DASHBOARD_SERVICE_ID" ]; then
            curl -X POST "https://api.render.com/v1/services/${RENDER_DASHBOARD_SERVICE_ID}/deploys" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache": false}'
            echo "url=https://home-credit-dashboard.onrender.com" >> $GITHUB_OUTPUT
            echo "âœ… DÃ©ploiement Dashboard dÃ©clenchÃ©"
          else
            echo "âš ï¸ Secrets Render non configurÃ©s - DÃ©ploiement simulÃ©"
            echo "url=https://home-credit-dashboard.onrender.com" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Job 5: Tests post-dÃ©ploiement
  # ============================================
  smoke-tests:
    name: ğŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-dashboard]
    
    steps:
      - name: â³ Attente du dÃ©ploiement
        run: sleep 90
      
      - name: ğŸ§ª Test API Health
        run: |
          API_URL="${{ needs.deploy-api.outputs.url }}"
          if [ -z "$API_URL" ]; then
            API_URL="https://home-credit-api.onrender.com"
          fi
          echo "ğŸ” Test de l'endpoint /health..."
          curl -f "${API_URL}/health" || echo "âš ï¸ API pas encore prÃªte (cold start Render)"
        continue-on-error: true
      
      - name: ğŸ§ª Test Dashboard Health
        run: |
          DASH_URL="${{ needs.deploy-dashboard.outputs.url }}"
          if [ -z "$DASH_URL" ]; then
            DASH_URL="https://home-credit-dashboard.onrender.com"
          fi
          echo "ğŸ” Test du dashboard..."
          curl -f "${DASH_URL}/_stcore/health" || echo "âš ï¸ Dashboard pas encore prÃªt"
        continue-on-error: true

  # ============================================
  # Job 6: Notification finale
  # ============================================
  notify:
    name: ğŸ“¬ Notification
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-dashboard, smoke-tests]
    if: always()
    
    steps:
      - name: ğŸ“¬ RÃ©sumÃ© du dÃ©ploiement
        run: |
          echo "=========================================="
          echo "       RÃ‰SUMÃ‰ DU DÃ‰PLOIEMENT"
          echo "=========================================="
          echo ""
          echo "ğŸŒ API:       ${{ needs.deploy-api.outputs.url }}"
          echo "ğŸ“Š Dashboard: ${{ needs.deploy-dashboard.outputs.url }}"
          echo ""
          if [[ "${{ needs.deploy-api.result }}" == "success" ]]; then
            echo "âœ… API dÃ©ployÃ©e avec succÃ¨s"
          else
            echo "âŒ Ã‰chec du dÃ©ploiement API"
          fi
          if [[ "${{ needs.deploy-dashboard.result }}" == "success" ]]; then
            echo "âœ… Dashboard dÃ©ployÃ© avec succÃ¨s"
          else
            echo "âŒ Ã‰chec du dÃ©ploiement Dashboard"
          fi
